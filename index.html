<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyTab Simulator</title>
  <style>
    :root { --border:#d9d9d9; --muted:#666; --bg:#fff; --panel:#fafafa; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color:#111; }
    header { padding: 14px 16px; border-bottom: 1px solid var(--border); }
    header h1 { margin: 0; font-size: 16px; font-weight: 700; }
    header p { margin: 4px 0 0; color: var(--muted); font-size: 12px; }

    .layout { display: grid; grid-template-columns: 420px 1fr; gap: 16px; padding: 16px; max-width: 1100px; margin: 0 auto; }
    .card { border: 1px solid var(--border); border-radius: 10px; background: var(--panel); padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 13px; font-weight: 700; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 12px; color:#111; margin: 0 0 4px; }
    .hint { font-size: 11px; color: var(--muted); margin-top: 2px; }
    input { width: 100%; padding: 9px 10px; border: 1px solid var(--border); border-radius: 8px; background:#fff; }
    .row { display:flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    button { padding: 9px 12px; border-radius: 8px; border: 1px solid var(--border); background:#fff; cursor: pointer; font-weight: 600; }
    button.primary { background:#111; color:#fff; border-color:#111; }

    .results { background:#fff; border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
    .results h2 { margin: 0 0 10px; font-size: 13px; font-weight: 700; }
    .kpis { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background:#fff; }
    .kpi .k { font-size: 11px; color: var(--muted); }
    .kpi .v { margin-top: 4px; font-size: 16px; font-weight: 800; }
    .section { margin-top: 14px; }
    .section h3 { margin: 0 0 8px; font-size: 12px; font-weight: 700; }
    pre { margin: 0; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background:#fff; overflow:auto; font-size: 12px; line-height: 1.35; }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>MyTab Simulator</h1>
    <p>Inputs on the left, calculated outputs on the right. No backend.</p>
  </header>

  <main class="layout">
    <!-- LEFT: Inputs -->
    <section class="card">
      <h2>Inputs</h2>

      <div class="grid">
        <div>
          <label for="T">T — Configurable Max Tab Limit</label>
          <input id="T" type="number" step="0.01" value="800" />
          <div class="hint">From PCM by device group & plan group</div>
        </div>
        <div>
          <label for="Y">Y — Available Customer Tab Limit</label>
          <input id="Y" type="number" step="0.01" value="650" />
          <div class="hint">Remaining tab room after credit</div>
        </div>

        <div>
          <label for="X">X — Total Allowed Tab Limit</label>
          <input id="X" type="number" step="0.01" value="1000" />
          <div class="hint">Reference (not used in formulas)</div>
        </div>
        <div>
          <label for="A">A — MSRP</label>
          <input id="A" type="number" step="0.01" value="1200" />
          <div class="hint">Device price</div>
        </div>

        <div>
          <label for="B">B — Trade Up Return Value</label>
          <input id="B" type="number" step="0.01" value="0" />
          <div class="hint">Non-tab related discount</div>
        </div>
        <div>
          <label for="C">C — Trade In Discount</label>
          <input id="C" type="number" step="0.01" value="150" />
          <div class="hint">One-time discount</div>
        </div>

        <div>
          <label for="L">L — Promo One-time</label>
          <input id="L" type="number" step="0.01" value="0" />
          <div class="hint">e.g., rollover wipe-out promo</div>
        </div>
        <div>
          <label for="M">M — Promo Monthly</label>
          <input id="M" type="number" step="0.01" value="10" />
          <div class="hint">Tab-related promo on top of subsidy</div>
        </div>

        <div>
          <label for="R">R — Subsidy Upper Limit</label>
          <input id="R" type="number" step="0.01" value="500" />
          <div class="hint">From catalog</div>
        </div>
        <div>
          <label for="O">O — Prepayment Ratio</label>
          <input id="O" type="number" step="0.0001" value="0.2" />
          <div class="hint">From credit class & tier (BSS)</div>
        </div>

        <div>
          <label for="H">H — Rollover Tab Charge</label>
          <input id="H" type="number" step="0.01" value="0" />
          <div class="hint">Old tab remaining charge</div>
        </div>
        <div>
          <label for="I">I — Rollover Tab Savings</label>
          <input id="I" type="number" step="0.01" value="0" />
          <div class="hint">Old tab remaining subsidy</div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label for="E">E — Voluntary Upfront Payment</label>
        <input id="E" type="number" step="0.01" value="0" />
        <div class="hint">Captured from UI (will be clamped to E ≤ F)</div>
      </div>

      <div class="row">
        <button class="primary" id="btnRun">Calculate</button>
        <button id="btnReset">Reset</button>
        <button id="btnCopy">Copy JSON</button>
      </div>
    </section>

    <!-- RIGHT: Outputs -->
    <section class="results">
      <h2>Outputs</h2>

      <div class="kpis">
        <div class="kpi"><div class="k">Z — Tab Limit</div><div class="v" id="outZ">—</div></div>
        <div class="kpi"><div class="k">D — Required Upfront Payment</div><div class="v" id="outD">—</div></div>
        <div class="kpi"><div class="k">Q — Tab Balance</div><div class="v" id="outQ">—</div></div>
        <div class="kpi"><div class="k">N — Subsidy</div><div class="v" id="outN">—</div></div>
        <div class="kpi"><div class="k">G — Tab Savings (N + M)</div><div class="v" id="outG">—</div></div>
        <div class="kpi"><div class="k">F — Tab Charge</div><div class="v" id="outF">—</div></div>
        <div class="kpi"><div class="k">J — Total Tab Charge (F + H)</div><div class="v" id="outJ">—</div></div>
        <div class="kpi"><div class="k">K — Total Tab Savings (G + I)</div><div class="v" id="outK">—</div></div>
        <div class="kpi"><div class="k">P — Prepayment</div><div class="v" id="outP">—</div></div>
        <div class="kpi"><div class="k">E (effective) — Voluntary Upfront Used</div><div class="v" id="outE">—</div></div>
      </div>

      <div class="section">
        <h3>Checks</h3>
        <pre id="checks">—</pre>
      </div>

      <div class="section">
        <h3>All Variables</h3>
        <pre id="vars">—</pre>
      </div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    function n(v) {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }

    function money(x) {
      if (!Number.isFinite(x)) return String(x);
      return new Intl.NumberFormat("en-CA", { style: "currency", currency: "CAD" }).format(x);
    }

    function readInputs() {
      const ids = ["T","X","Y","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","Z"];
      // only reading defined UI fields:
      return {
        T: n($("T").value),
        X: n($("X").value),
        Y: n($("Y").value),
        A: n($("A").value),
        B: n($("B").value),
        C: n($("C").value),
        E: n($("E").value),
        R: n($("R").value),
        M: n($("M").value),
        O: n($("O").value),
        H: n($("H").value),
        I: n($("I").value),
        L: n($("L").value),
      };
    }

    function calculate(inp) {
      // Order:
      // 1) Z
      // 2) D (no B)
      // 3) Q
      // 4) N, G
      // 5) F (L once)
      // 6) J, K
      // 7) P (rollover excludes)
      const out = { ...inp };

      // 1) Tab Limit
      out.Z = Math.min(out.Y, out.T, out.A);

      // 2) Required Upfront Payment (D) — confirmed: NO B
      // D = A + (H + I) - (C + L) - Z
      out.D_raw = out.A + out.H + out.I - (out.C + out.L) - out.Z;
      out.D = Math.max(0, out.D_raw);

      // 3) Tab Balance (Q)
      // Q = A - (B + C + L) - D - E
      out.Q_raw = out.A - (out.B + out.C + out.L) - out.D - out.E;
      out.Q = Math.max(0, out.Q_raw);

      // 4) Subsidy (N) and Tab Savings (G)
      // N = min(R, Q); G = N + M; G <= Q
      out.N = Math.max(0, Math.min(out.R, out.Q));
      out.G = Math.max(0, out.N + out.M);
      out.G = Math.min(out.G, out.Q);

      // 5) Tab Charge (F) — L subtracted once (confirmed)
      // F = A - (B + C + L) - G - (D + E)
      out.F_raw = out.A - (out.B + out.C + out.L) - out.G - (out.D + out.E);
      out.F = Math.max(0, out.F_raw);

      // Rule: E <= F. If violated, clamp E and recompute Q, N, G, F consistently.
      if (out.E > out.F) {
        out.E_clamped = true;
        out.E = out.F;

        out.Q_raw = out.A - (out.B + out.C + out.L) - out.D - out.E;
        out.Q = Math.max(0, out.Q_raw);

        out.N = Math.max(0, Math.min(out.R, out.Q));
        out.G = Math.max(0, out.N + out.M);
        out.G = Math.min(out.G, out.Q);

        out.F_raw = out.A - (out.B + out.C + out.L) - out.G - (out.D + out.E);
        out.F = Math.max(0, out.F_raw);
      } else {
        out.E_clamped = false;
      }

      // 6) Totals
      out.J = out.F + out.H;
      out.K = out.G + out.I;

      // 7) Prepayment
      // Rollover and prepayment exclude each other -> if rollover included => P = 0
      // rolloverIncluded = (H>0 || I>0)
      // P = O * [A - (C + L) - (D + E)]
      out.rolloverIncluded = (out.H > 0) || (out.I > 0);
      out.P_base = out.A - (out.C + out.L) - (out.D + out.E);
      out.P = out.rolloverIncluded ? 0 : Math.max(0, out.O * out.P_base);

      // Sanity
      out.Q_check = out.F + out.G;
      out.Q_diff = (out.Q_check - out.Q);

      return out;
    }

    function render(out) {
      $("outZ").textContent = money(out.Z);
      $("outD").textContent = money(out.D);
      $("outQ").textContent = money(out.Q);
      $("outN").textContent = money(out.N);
      $("outG").textContent = money(out.G);
      $("outF").textContent = money(out.F);
      $("outJ").textContent = money(out.J);
      $("outK").textContent = money(out.K);
      $("outP").textContent = money(out.P);
      $("outE").textContent = money(out.E);

      const checks = [];
      checks.push(`Z <= A, Y, T: ${ (out.Z <= out.A && out.Z <= out.Y && out.Z <= out.T) ? "OK" : "FAIL" }`);
      checks.push(`E <= F: ${ (out.E <= out.F) ? "OK" : "FAIL" }${ out.E_clamped ? " (E was clamped)" : "" }`);
      checks.push(`Q == F + G: ${ Math.abs(out.Q_diff) < 0.0001 ? "OK" : "WARN" } (diff: ${out.Q_diff})`);
      checks.push(`Rollover excludes prepayment: ${ out.rolloverIncluded ? (out.P === 0 ? "OK" : "FAIL") : "N/A" }`);
      $("checks").textContent = checks.join("\n");

      $("vars").textContent = JSON.stringify(out, null, 2);
    }

    function run() {
      const inputs = readInputs();
      const out = calculate(inputs);
      render(out);
    }

    function reset() {
      $("T").value = 800;
      $("Y").value = 650;
      $("X").value = 1000;
      $("A").value = 1200;
      $("B").value = 0;
      $("C").value = 150;
      $("L").value = 0;
      $("M").value = 10;
      $("R").value = 500;
      $("O").value = 0.2;
      $("H").value = 0;
      $("I").value = 0;
      $("E").value = 0;
      run();
    }

    $("btnRun").addEventListener("click", run);
    $("btnReset").addEventListener("click", reset);
    $("btnCopy").addEventListener("click", async () => {
      const payload = { inputs: readInputs(), outputs: calculate(readInputs()) };
      await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
      alert("Copied JSON to clipboard.");
    });

    // auto-calc on change
    ["T","X","Y","A","B","C","E","R","M","O","H","I","L"].forEach(id => {
      $(id).addEventListener("input", run);
    });

    run();
  </script>
</body>
</html>
