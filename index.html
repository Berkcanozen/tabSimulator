<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyTab Simulator</title>
  <style>
    :root{
      --border:#d9d9d9;
      --muted:#666;
      --bg:#fff;
      --panel:#fafafa;
      --green:#0a8a2a;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:#111; }
    header{ padding:14px 16px; border-bottom:1px solid var(--border); }
    header h1{ margin:0; font-size:16px; font-weight:700; }
    header p{ margin:4px 0 0; color:var(--muted); font-size:12px; }

    .layout{ display:grid; grid-template-columns: 420px 1fr; gap:16px; padding:16px; max-width:1100px; margin:0 auto; }
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }

    .card{ border:1px solid var(--border); border-radius:10px; background:var(--panel); padding:14px; }
    .results{ border:1px solid var(--border); border-radius:10px; background:#fff; padding:14px; }

    h2{ margin:0 0 10px; font-size:13px; font-weight:700; }
    label{ display:block; font-size:12px; margin:0 0 4px; }
    .hint{ font-size:11px; color:var(--muted); margin-top:2px; }

    input{ width:100%; padding:9px 10px; border:1px solid var(--border); border-radius:8px; background:#fff; }
    .field{ margin-bottom:10px; }

    .row{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    button{ padding:9px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:600; }
    button.primary{ background:#111; color:#fff; border-color:#111; }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{ display:flex; justify-content:space-between; gap:12px; align-items:baseline; padding:8px 10px; border:1px solid var(--border); border-radius:10px; }
    .item .k{ font-size:12px; color:var(--muted); }
    .item .v{ font-size:14px; font-weight:800; color:var(--green); }

    .section{ margin-top:14px; }
    .section h3{ margin:0 0 8px; font-size:12px; font-weight:700; }
    pre{ margin:0; padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff; overflow:auto; font-size:12px; line-height:1.35; white-space:pre-wrap; }
    details{ border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; }
    summary{ cursor:pointer; font-weight:700; font-size:12px; }
  </style>
</head>
<body>
<header>
  <h1>MyTab Simulator</h1>
  <p>Inputs on the left, calculated outputs on the right. Shareable via GitHub Pages.</p>
</header>

<main class="layout">
  <!-- LEFT: Inputs -->
  <section class="card">
    <h2>Inputs</h2>

    <!-- T and Y at the top -->
    <div class="field">
      <label for="T">T — Configurable Max Tab Limit</label>
      <input id="T" type="number" step="0.01" value="800" />
      <div class="hint">From PCM by device group &amp; plan group</div>
    </div>

    <div class="field">
      <label for="Y">Y — Available Customer Tab Limit</label>
      <input id="Y" type="number" step="0.01" value="650" />
      <div class="hint">Remaining customer tab room after credit</div>
    </div>

    <!-- Then remaining inputs in single column alphabetical by letter -->
    <div class="field">
      <label for="A">A — MSRP</label>
      <input id="A" type="number" step="0.01" value="1200" />
      <div class="hint">Device price</div>
    </div>

    <div class="field">
      <label for="B">B — Trade Up Return Value</label>
      <input id="B" type="number" step="0.01" value="0" />
      <div class="hint">Non-tab related discount</div>
    </div>

    <div class="field">
      <label for="C">C — Trade In Discount</label>
      <input id="C" type="number" step="0.01" value="150" />
      <div class="hint">One-time discount</div>
    </div>

    <div class="field">
      <label for="E">E — Voluntary Upfront Payment</label>
      <input id="E" type="number" step="0.01" value="0" />
      <div class="hint">Voluntary upfront; reduces Tab Balance/Charge (subject to E ≤ F rule)</div>
    </div>

    <div class="field">
      <label for="H">H — Rollover Tab Charge</label>
      <input id="H" type="number" step="0.01" value="0" />
      <div class="hint">Old tab remaining charge</div>
    </div>

    <div class="field">
      <label for="I">I — Rollover Tab Savings</label>
      <input id="I" type="number" step="0.01" value="0" />
      <div class="hint">Old tab remaining subsidy</div>
    </div>

    <div class="field">
      <label for="L">L — Promo One-time</label>
      <input id="L" type="number" step="0.01" value="0" />
      <div class="hint">Non-tab related one-time promo</div>
    </div>

    <div class="field">
      <label for="M">M — Promo Monthly</label>
      <input id="M" type="number" step="0.01" value="10" />
      <div class="hint">Tab-related promo on top of subsidy</div>
    </div>

    <div class="field">
      <label for="O">O — Prepayment Ratio</label>
      <input id="O" type="number" step="0.0001" value="0.2" />
      <div class="hint">From credit class &amp; tier (BSS)</div>
    </div>

    <div class="field">
      <label for="R">R — Subsidy Upper Limit</label>
      <input id="R" type="number" step="0.01" value="500" />
      <div class="hint">From catalog</div>
    </div>

    <div class="row">
      <button class="primary" id="btnRun">Calculate</button>
      <button id="btnReset">Reset</button>
      <button id="btnCopy">Copy JSON</button>
    </div>
  </section>

  <!-- RIGHT: Outputs + Formulas -->
  <section class="results">
    <h2>Outputs (Alphabetical)</h2>

    <!-- Alphabetical single column: D, E(effective), F, G, J, K, N, P, Q, Z -->
    <div class="list">
      <div class="item"><div class="k">D — Required Upfront Payment</div><div class="v" id="outD">—</div></div>
      <div class="item"><div class="k">E (effective) — Voluntary Upfront Used</div><div class="v" id="outE">—</div></div>
      <div class="item"><div class="k">F — Current Tab Charge (MyTab Charge)</div><div class="v" id="outF">—</div></div>
      <div class="item"><div class="k">G — Current Tab Savings</div><div class="v" id="outG">—</div></div>
      <div class="item"><div class="k">J — Total Tab Charge (F + H)</div><div class="v" id="outJ">—</div></div>
      <div class="item"><div class="k">K — Total Tab Savings (G + I)</div><div class="v" id="outK">—</div></div>
      <div class="item"><div class="k">N — Subsidy (min(R, Q))</div><div class="v" id="outN">—</div></div>
      <div class="item"><div class="k">P — Prepayment</div><div class="v" id="outP">—</div></div>
      <div class="item"><div class="k">Q — Tab Balance</div><div class="v" id="outQ">—</div></div>
      <div class="item"><div class="k">Z — Tab Limit</div><div class="v" id="outZ">—</div></div>
    </div>

    <div class="section">
      <h3>Checks</h3>
      <pre id="checks">—</pre>
    </div>

    <div class="section">
      <details open>
        <summary>Formulas (Calculation Order)</summary>
        <pre id="formulas"></pre>
      </details>
    </div>

    <div class="section">
      <details>
        <summary>All Variables (JSON)</summary>
        <pre id="vars">—</pre>
      </details>
    </div>
  </section>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function n(v){
    const x = Number(v);
    return Number.isFinite(x) ? x : 0;
  }
  function money(x){
    if (!Number.isFinite(x)) return String(x);
    return new Intl.NumberFormat("en-CA", { style:"currency", currency:"CAD" }).format(x);
  }

  function readInputs(){
    // Only the UI inputs that remain: (no X)
    return {
      T: n($("T").value),
      Y: n($("Y").value),
      A: n($("A").value),
      B: n($("B").value),
      C: n($("C").value),
      E_input: n($("E").value),
      H: n($("H").value),
      I: n($("I").value),
      L: n($("L").value),
      M: n($("M").value),
      O: n($("O").value),
      R: n($("R").value),
    };
  }

  function calculate(inp){
    // Your confirmed rules:
    // 1) Z = min(Y, T, A)
    // 2) D = A + (H + I) - (C + L) - Z      (NO B)
    // 3) Q = A - (B + C + L) - D - E
    // 4) N = min(R, Q), G = min(Q, N + M)
    // 5) F = A - (B + C + L) - G - (D + E)  (L only once)
    // 6) J = F + H, K = G + I
    // 7) P = 0 if rollover (H>0 or I>0) else O * [A - (C + L) - (D + E)]
    //
    // E rule: E <= F (and E should reduce F). We solve this with a short fixed-point iteration.

    const out = { ...inp };

    // Step 1: Z
    out.Z = Math.min(out.Y, out.T, out.A);

    // Step 2: D (NO B)
    out.D_raw = out.A + out.H + out.I - (out.C + out.L) - out.Z;
    out.D = Math.max(0, out.D_raw);

    // Iterative solve for E effective under constraint E <= F
    // Start with requested E_input; recompute until stable.
    let E = Math.max(0, out.E_input);
    let clamped = false;

    for (let i = 0; i < 10; i++){
      // Step 3: Q
      const Q_raw = out.A - (out.B + out.C + out.L) - out.D - E;
      const Q = Math.max(0, Q_raw);

      // Step 4: N, G
      const N = Math.max(0, Math.min(out.R, Q));
      let G = Math.max(0, N + out.M);
      G = Math.min(G, Q);

      // Step 5: F
      const F_raw = out.A - (out.B + out.C + out.L) - G - (out.D + E);
      const F = Math.max(0, F_raw);

      // Enforce E <= F
      const newE = Math.min(out.E_input, F);
      clamped = clamped || (newE < out.E_input);

      // If stable, finalize
      if (Math.abs(newE - E) < 0.0001){
        out.Q_raw = Q_raw; out.Q = Q;
        out.N = N; out.G = G;
        out.F_raw = F_raw; out.F = F;
        E = newE;
        break;
      }
      E = newE;

      // On last iteration, finalize anyway
      if (i === 9){
        out.Q_raw = Q_raw; out.Q = Q;
        out.N = N; out.G = G;
        out.F_raw = F_raw; out.F = F;
      }
    }

    out.E = E;
    out.E_clamped = clamped;

    // Step 6: J, K
    out.J = out.F + out.H;
    out.K = out.G + out.I;

    // Step 7: P (rollover excludes)
    out.rolloverIncluded = (out.H > 0) || (out.I > 0);
    out.P_base = out.A - (out.C + out.L) - (out.D + out.E);
    out.P = out.rolloverIncluded ? 0 : Math.max(0, out.O * out.P_base);

    // Sanity
    out.Q_check = out.F + out.G;
    out.Q_diff = out.Q_check - out.Q;

    return out;
  }

  function render(out){
    $("outD").textContent = money(out.D);
    $("outE").textContent = money(out.E);
    $("outF").textContent = money(out.F);
    $("outG").textContent = money(out.G);
    $("outJ").textContent = money(out.J);
    $("outK").textContent = money(out.K);
    $("outN").textContent = money(out.N);
    $("outP").textContent = money(out.P);
    $("outQ").textContent = money(out.Q);
    $("outZ").textContent = money(out.Z);

    const checks = [];
    checks.push(`Z <= A, Y, T: ${(out.Z <= out.A && out.Z <= out.Y && out.Z <= out.T) ? "OK" : "FAIL"}`);
    checks.push(`E <= F: ${(out.E <= out.F) ? "OK" : "FAIL"}${out.E_clamped ? " (requested E was clamped)" : ""}`);
    checks.push(`Q == F + G: ${(Math.abs(out.Q_diff) < 0.0001) ? "OK" : "WARN"} (diff: ${out.Q_diff})`);
    checks.push(`Rollover excludes prepayment: ${out.rolloverIncluded ? (out.P === 0 ? "OK" : "FAIL") : "N/A"}`);
    $("checks").textContent = checks.join("\n");

    $("vars").textContent = JSON.stringify(out, null, 2);
  }

  function setFormulas(){
    $("formulas").textContent =
`Calculation Order

1) Z — Tab Limit
   Z = min(Y, T, A)

2) D — Required Upfront Payment (NO B)
   D = max(0, A + H + I - (C + L) - Z)

3) Q — Tab Balance
   Q = max(0, A - (B + C + L) - D - E)

4) N — Subsidy and G — Tab Savings
   N = max(0, min(R, Q))
   G = min(Q, max(0, N + M))

5) F — Current Tab Charge (MyTab Charge)
   F = max(0, A - (B + C + L) - G - (D + E))

   Business rule: E <= F
   (If requested E violates this, the simulator clamps E to satisfy the rule and recalculates.)

6) J and K Totals
   J = F + H
   K = G + I

7) P — Prepayment (does NOT impact tab calculation)
   If rollover included (H > 0 or I > 0) => P = 0
   Else:
   P = max(0, O * [A - (C + L) - (D + E)])`;
  }

  function run(){
    const inputs = readInputs();
    const out = calculate(inputs);
    render(out);
  }

  function reset(){
    $("T").value = 800;
    $("Y").value = 650;

    $("A").value = 1200;
    $("B").value = 0;
    $("C").value = 150;
    $("E").value = 0;
    $("H").value = 0;
    $("I").value = 0;
    $("L").value = 0;
    $("M").value = 10;
    $("O").value = 0.2;
    $("R").value = 500;

    run();
  }

  $("btnRun").addEventListener("click", run);
  $("btnReset").addEventListener("click", reset);
  $("btnCopy").addEventListener("click", async () => {
    const payload = { inputs: readInputs(), outputs: calculate(readInputs()) };
    await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
    alert("Copied JSON to clipboard.");
  });

  // Auto-calc on input change (still keeps Calculate button behavior)
  ["T","Y","A","B","C","E","H","I","L","M","O","R"].forEach(id => {
    $(id).addEventListener("input", run);
  });

  setFormulas();
  run();
</script>
</body>
</html>
